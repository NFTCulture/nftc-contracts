# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**nftc-contracts** is NFTCulture's open-source Solidity contract library and the foundation of their corporate smart contract stack. It provides reusable contract components, testing utilities, and TypeScript helpers for NFT and DeFi development. All downstream NFTCulture projects depend on the exact dependency versions defined here.

**Critical**: This is the root dependency for the entire NFTCulture stack. Changes here cascade to all downstream projects.

## Environment Setup

Required files (not in repo):
- `.env` - Created from `.env_proto`. Minimal secrets needed to start.
- `.npmrc` - Created from `.npmrc_proto`. Requires GitHub auth token for accessing @nftculture packages.

## Commands

### Build & Compile
```bash
npm run build              # Full build: compile contracts + TypeScript module
npm run build:hardhat      # Compile Solidity contracts only
npm run build:ts-module    # Build TypeScript module only (clean, create-index, compile)
npx hardhat clean          # Clean artifacts and cache
npx hardhat compile        # Compile contracts and generate TypeChain types
```

### Testing
```bash
npm run test               # Run all tests (parallel, with typecheck)
npm run test:np            # Run tests without parallelization
npm test -- --grep "pattern"  # Run specific test by pattern
npx hardhat test test/contracts/financial/LockedPaymentSplitter.test.ts  # Run single test file
npm run test:gas           # Run tests with gas reporting (set REPORT_GAS=true)
npm run test:coverage      # Generate coverage report
npm run test:coverage:view # Open coverage report in browser
```

### Code Quality
```bash
npm run fix                # Run all fixes: prettier-sol, prettier-ts, eslint --fix
npm run typecheck          # TypeScript type checking (no emit)
```

### Publishing
```bash
npm run pub                # Full: fix, build, test, publish to GitHub registry
npm run pub:dry            # Dry run without publishing
npm run publish:commit     # Publish to GitHub package registry
npm run publish:dry        # Publish dry run
```

## Architecture

### Dual-Output Structure

This project produces **two outputs**:

1. **Solidity Contracts** (`contracts/`) → Compiled artifacts + TypeChain types
   - Published in package for importing into other Solidity projects
   - TypeChain types generated in `typechain-types/` directory

2. **TypeScript Library** (`src/`) → Compiled module in `dist/nftc/`
   - Published as importable TypeScript package
   - Used by downstream projects for test utilities and behaviors
   - Built with `tsconfig.module.json` (separate from test tsconfig)

### Contract Organization

```
contracts/
├── financial/          # Payment splitters, royalty contracts (ERC2981)
├── security/           # Delegate enforcement, contract guards
├── token/              # Token implementations
│   ├── opensea/seadrop/   # SeaDrop integration (ERC721)
│   ├── solbase/           # Solbase ERC721 (vendored, not in npm)
│   ├── openzeppelin/      # OZ extensions (e.g., ERC20_165)
│   └── pagzhi/            # Custom ERC721 implementations
├── utility/            # Helpers (AuxHelper, introspection, onchain encoding)
├── meta/               # Contract metadata (ERC7572)
├── interfaces/         # Interface definitions (IDelegationRegistry, Manifold, Scripty)
├── mocks/              # Test mocks (MockDelegationRegistry, etc.)
└── general/            # General utilities (GasRefunder)
```

### TypeScript Library (`src/`)

**Purpose**: Portable test utilities and reusable behaviors for contract testing.

```
src/
├── behaviors/                    # Reusable test behaviors (Mocha describe blocks)
│   ├── financial/Payee.ts       # Royalty payee validation tests
│   ├── token/URI.ts             # URI validation tests (721/1155)
│   └── utility/introspection/   # ERC165 interface support tests
│       ├── SupportsInterfaces.ts         # OpenZeppelin interface tests
│       └── SupportsInterfacesManifold.ts # Manifold interface tests
├── for-tests/
│   ├── context/
│   │   ├── HardhatHelpers.ts    # addHardhatSignersToContext() hook
│   │   └── augmentations.d.ts   # Mocha context type extensions
│   ├── assertions/MochaHelpers.ts  # skipIfDefault() utility
│   └── utils/introspection/     # Interface ID computation (ERC165)
│       ├── OZ_Interfaces.ts     # OpenZeppelin interface definitions
│       ├── MXYZ_Interfaces.ts   # Manifold interface definitions
│       └── makeInterfaceId.ts   # ERC165() function
└── index.ts                      # Auto-generated by create-ts-index
```

### Test Structure

```
test/
├── contracts/           # Solidity contract tests
│   ├── financial/      # Payment splitter, royalty tests
│   ├── security/       # Delegate enforcer tests
│   ├── token/          # Token implementation tests
│   ├── utility/        # Utility contract tests
│   ├── interfaces/     # Interface compliance tests
│   └── meta/           # Metadata contract tests
└── typescript/          # TypeScript utility tests
    ├── behaviors/      # Tests for behavior functions
    └── for-tests/      # Tests for test utilities
```

## Key Patterns

### Test Pattern (TypeChain Types)

Always use **string literals** in `getContractFactory()` for proper TypeChain type inference:

```typescript
import { MyContract, MyContract__factory } from '../../typechain-types';

let _contractFactory: MyContract__factory;
let _contractInstance: MyContract;

before(async function () {
    // Use string literal - TypeChain infers factory type
    _contractFactory = await hre.ethers.getContractFactory("MyContract");
});

beforeEach(async function () {
    _contractInstance = await _contractFactory.deploy();
    await _contractInstance.waitForDeployment();
});
```

**Never** use type assertions like `as MyContract__factory` - this bypasses type checking.

### Behavior Pattern (Reusable Tests)

Behaviors are Mocha `describe` blocks that can be imported and reused:

```typescript
// In test file
import { shouldSupportInterfaces } from '../../src';

describe('MyContract', function () {
    beforeEach(async function () {
        this.contractUnderTest = myContractInstance;
        this.owner = ownerSigner;
    });

    shouldSupportInterfaces('MyContract', ['ERC165', 'ERC721', 'ERC721Metadata']);
});
```

Behaviors expect `this.contractUnderTest` and `this.owner` to be set via Mocha context (see `augmentations.d.ts`).

### Mock Injection Pattern (Replacing Smock)

This project **does not use smock** (removed in v2.0.0 - no ethers v6 support). Instead:

1. **Enhanced mocks** with configurable behavior (e.g., `MockDelegationRegistry.setMockDelegation()`)
2. **Hardhat's `hardhat_setCode`** to inject mocks at specific addresses

Example from `NFTCDelegateEnforcer.test.ts`:
```typescript
beforeEach(async function () {
    _delegationRegistryInstance = await _delegationRegistryFactory.deploy();
    await _delegationRegistryInstance.waitForDeployment();

    // Inject mock at canonical address
    const DELEGATION_REGISTRY_ADDRESS = '0x00000000000076A84feF008CDAbe6409d2FE638B';
    const code = await hre.ethers.provider.getCode(await _delegationRegistryInstance.getAddress());
    await hre.network.provider.send('hardhat_setCode', [DELEGATION_REGISTRY_ADDRESS, code]);

    // Attach to injected address
    _delegationRegistryInstance = _delegationRegistryFactory.attach(DELEGATION_REGISTRY_ADDRESS);
});
```

### Context Hook Pattern

Use `addHardhatSignersToContext()` to populate Mocha context with signers:

```typescript
import { addHardhatSignersToContext } from '../../src';

describe('MyContract', function () {
    addHardhatSignersToContext(); // Adds this.owner, this.addr1, etc.

    it('should work', async function () {
        // this.owner, this.addr1, this.addr2, etc. are now available
        await contract.connect(this.owner).someFunction();
    });
});
```

## Dependency Management

**Critical**: See `docs/dependencies.md` for exact versions to use. All downstream projects must align with these versions.

### Version Constraints
- **Hardhat 2.x only** - NOT upgrading to Hardhat 3 (requires Rust)
- **Ethers v6** - Breaking change from v5 (see docs/dependencies.md for migration guide)
- **TypeScript 5.9.3** - Requires typescript-eslint ^8.x
- **Do NOT install** packages included in hardhat-toolbox separately

### Solidity Compiler
- **Current**: 0.8.30
- Custom compiler path can be configured in `hardhat.config.ts` via `TASK_COMPILE_SOLIDITY_GET_SOLC_BUILD` subtask (currently disabled to allow Hardhat to auto-download)
- For CI/CD, compiler can be cached in `.solc_cache/` directory

## Important Notes

### TypeChain Type Generation
- TypeChain types are generated in `typechain-types/` during `npx hardhat compile`
- If types are missing, run: `npx hardhat clean && npx hardhat compile`
- TypeChain version 8.3.0 targets ethers-v6

### ESLint and Type Safety
- `contractUnderTest: any` in `augmentations.d.ts` is intentional (allows behaviors to work with any contract type)
- Has `eslint-disable-next-line @typescript-eslint/no-explicit-any` comment
- For `Fragment`/`FunctionFragment` in behaviors, use explicit types: `(f: Fragment): f is FunctionFragment =>`

### Publishing Flow
- Package is published to GitHub Package Registry (`@nftculture/nftc-contracts`)
- Requires `.npmrc` with GitHub auth token
- Both compiled contracts AND TypeScript module are included in package (see `files` in package.json)
- `dist/nftc/` contains compiled TypeScript library
- `contracts/` contains Solidity source files

### Contract Dependencies
- **Solbase ERC721**: Vendored in `contracts/token/solbase/` (not available via npm)
- **ERC721A**: Installed via `erc721a` package
- **OpenZeppelin**: Installed via `@openzeppelin/contracts` (v4.9.5)
- **SeaDrop**: Custom NFTC implementation in `contracts/token/opensea/seadrop/`

## References

- Dependency versions and migration guide: `docs/dependencies.md`
- Changelog: `CHANGELOG.md`
- README: `README.md`
